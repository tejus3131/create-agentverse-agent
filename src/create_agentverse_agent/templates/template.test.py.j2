"""
A Streamlit-based chat interface that supports asynchronous message processing with progress updates.

Features:
- User authentication via name input.
- Unique session and user IDs for each chat session.
- Displays chat history between user and assistant.
- Shows real-time progress logs for assistant responses.
- Supports resetting the chat session.
- Uses an async `chat` function (mocked if not available) to simulate or process messages.
- Logs all interactions and progress updates.

Modules:
- streamlit: For UI and session state management.
- asyncio: For asynchronous message processing.
- uuid: For generating unique session IDs.
- datetime: For timestamping progress logs.
- typing: For type annotations.
- logging: For logging events and progress.

To use with your own agent, implement the `chat` function in `agent.py` with the specified signature.
"""

import streamlit as st
import asyncio
import uuid
from datetime import datetime
from typing import Callable
import logging
try:
    from agent import chat
except ImportError:
    # Mock chat function for testing purposes
    async def chat(
        session_id: str,
        user_id: str,
        message: str,
        logger: logging.Logger,
        send_progress: Callable[[str], None]
    ) -> str:
        """
        Example chat function with progress updates.
        Replace this with your actual chat/AI logic.
        """
        logger.info(f"[{session_id}] Received message from user {user_id}: {message}")
        send_progress("Starting processing... 0% complete")

        PROGRESS_COUNT = 3

        for i in range(PROGRESS_COUNT):
            await asyncio.sleep(1) # Simulate processing time
            send_progress(f"Processing... {((i + 1) / PROGRESS_COUNT) * 100:.0f}% complete")
            logger.info(f"[{session_id}] Processing... {((i + 1) / PROGRESS_COUNT) * 100:.0f}% complete")

        response = (
            f"Hello, `{user_id}`!\n\nI am `{{ display_name }}`.\n\nYour message was: `{message}`.\n\nSession ID: `{session_id}`\n\n\n"
            "> This is a simulated response after processing your message.\n"
            "> Add `chat` method in `agent.py` with your actual logic.\n\n"
            "Follow following format:\n\n\n"
            "```python\n"
            "async def chat(\n"
            "\tsession_id: str,\n"
            "\tuser_id: str,\n"
            "\tmessage: str,\n"
            "\tlogger: Logger,\n"
            "\tsend_progress: Callable[[str], None]\n"
            ") -> str\n"
            "\t# Add your chat logic here\n"
            "```\n"
        )

        return response

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize session state
if "session_id" not in st.session_state:
    st.session_state.session_id = str(uuid.uuid4())
    st.session_state.user_id = None
    st.session_state.messages = []
    st.session_state.progress_logs = {}

def new_chat():
    """Reset chat session"""
    st.session_state.session_id = str(uuid.uuid4())
    st.session_state.messages = []
    st.session_state.progress_logs = {}

# Check if user has entered their name
if st.session_state.user_id is None:
    st.title("üí¨ Welcome to Chat Interface")
    st.write("Please enter your name to start chatting")

    with st.form("user_name_form"):
        user_name = st.text_input("Your Name", placeholder="Enter your name...")
        submit_button = st.form_submit_button("Start Chat")

        if submit_button:
            if user_name.strip():
                st.session_state.user_id = user_name.strip()
                st.rerun()
            else:
                st.error("Please enter a valid name")

    st.stop()

# Main UI
st.title("üí¨ Chat Interface")

# Header with session info and new chat button
col1, col2 = st.columns([3, 1])
with col1:
    st.caption(f"**Session ID:** `{st.session_state.session_id[:8]}...`")
    st.caption(f"**User ID:** `{st.session_state.user_id}`")
with col2:
    if st.button("üîÑ New Chat", use_container_width=True):
        new_chat()
        st.rerun()

st.divider()

# Chat messages container
chat_container = st.container()

with chat_container:
    for idx, msg in enumerate(st.session_state.messages):
        if msg["role"] == "user":
            with st.chat_message("user"):
                st.write(msg["content"])
        else:
            with st.chat_message("assistant"):
                st.write(msg["content"])

                # Show progress logs in expander
                if idx in st.session_state.progress_logs:
                    with st.expander("üìä View Progress Logs"):
                        for log in st.session_state.progress_logs[idx]:
                            st.text(f"[{log['timestamp']}] {log['message']}")

# Chat input
if prompt := st.chat_input("Type your message..."):
    # Add user message
    st.session_state.messages.append({"role": "user", "content": prompt})

    # Display user message
    with chat_container:
        with st.chat_message("user"):
            st.write(prompt)

    # Show assistant response with progress
    msg_index = len(st.session_state.messages)

    with chat_container:
        with st.chat_message("assistant"):
            # Progress placeholder
            progress_placeholder = st.empty()
            response_placeholder = st.empty()

            # Initialize progress tracking
            st.session_state.progress_logs[msg_index] = []

            # Create async task with progress updates
            async def run_chat_with_updates():
                def send_progress(progress_msg: str):
                    st.session_state.progress_logs[msg_index].append({
                        "timestamp": datetime.now().strftime("%H:%M:%S"),
                        "message": progress_msg
                    })
                    # Update the UI in real-time
                    progress_placeholder.info(f"‚è≥ {progress_msg}")

                response = await chat(
                    st.session_state.session_id,
                    st.session_state.user_id,
                    prompt or "",
                    logger,
                    send_progress
                )
                return response

            # Run the async function
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            try:
                response = loop.run_until_complete(run_chat_with_updates())
            finally:
                loop.close()

            # Clear progress and show response
            progress_placeholder.empty()
            response_placeholder.write(response)

            # Show progress logs in expander
            if msg_index in st.session_state.progress_logs:
                with st.expander("üìä View Progress Logs"):
                    for log in st.session_state.progress_logs[msg_index]:
                        st.text(f"[{log['timestamp']}] {log['message']}")

    # Add assistant response to history
    st.session_state.messages.append({"role": "assistant", "content": response})

    st.rerun()
