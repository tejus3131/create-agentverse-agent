import streamlit as st
import asyncio
import uuid
from datetime import datetime
from typing import Callable
import logging
import time

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Mock chat function (replace with your actual implementation)
async def chat(
    session_id: str,
    user_id: str,
    message: str,
    logger: logging.Logger,
    send_progress: Callable[[str], None]
) -> str:
    """
    Example chat function with progress updates.
    Replace this with your actual chat/AI logic.
    """
    logger.info(f"[{session_id}] Received message from user {user_id}: {message}")
    send_progress("Starting processing... 0% complete")

    PROGRESS_COUNT = 2
    SLEEP_INTERVAL = 2  # seconds

    for i in range(PROGRESS_COUNT):
        await asyncio.sleep(SLEEP_INTERVAL)  # Simulate processing time
        send_progress(f"Processing... {((i + 1) / PROGRESS_COUNT) * 100:.0f}% complete")
        logger.info(f"[{session_id}] Processing... {((i + 1) / PROGRESS_COUNT) * 100:.0f}% complete")

    return f"Hello, {user_id}! I am Agent ee7be4ef. You said: '{message}'"

# Initialize session state
if "session_id" not in st.session_state:
    st.session_state.session_id = str(uuid.uuid4())
    st.session_state.user_id = None
    st.session_state.messages = []
    st.session_state.progress_logs = {}

def new_chat():
    """Reset chat session"""
    st.session_state.session_id = str(uuid.uuid4())
    st.session_state.messages = []
    st.session_state.progress_logs = {}

# Check if user has entered their name
if st.session_state.user_id is None:
    st.title("üí¨ Welcome to Chat Interface")
    st.write("Please enter your name to start chatting")

    with st.form("user_name_form"):
        user_name = st.text_input("Your Name", placeholder="Enter your name...")
        submit_button = st.form_submit_button("Start Chat")

        if submit_button:
            if user_name.strip():
                st.session_state.user_id = user_name.strip()
                st.rerun()
            else:
                st.error("Please enter a valid name")

    st.stop()

# Main UI
st.title("üí¨ Chat Interface")

# Header with session info and new chat button
col1, col2 = st.columns([3, 1])
with col1:
    st.caption(f"**Session ID:** `{st.session_state.session_id[:8]}...`")
    st.caption(f"**User ID:** `{st.session_state.user_id}`")
with col2:
    if st.button("üîÑ New Chat", use_container_width=True):
        new_chat()
        st.rerun()

st.divider()

# Chat messages container
chat_container = st.container()

with chat_container:
    for idx, msg in enumerate(st.session_state.messages):
        if msg["role"] == "user":
            with st.chat_message("user"):
                st.write(msg["content"])
        else:
            with st.chat_message("assistant"):
                st.write(msg["content"])

                # Show progress logs in expander
                if idx in st.session_state.progress_logs:
                    with st.expander("üìä View Progress Logs"):
                        for log in st.session_state.progress_logs[idx]:
                            st.text(f"[{log['timestamp']}] {log['message']}")

# Chat input
if prompt := st.chat_input("Type your message..."):
    # Add user message
    st.session_state.messages.append({"role": "user", "content": prompt})

    # Display user message
    with chat_container:
        with st.chat_message("user"):
            st.write(prompt)

    # Show assistant response with progress
    msg_index = len(st.session_state.messages)

    with chat_container:
        with st.chat_message("assistant"):
            # Progress placeholder
            progress_placeholder = st.empty()
            response_placeholder = st.empty()

            # Initialize progress tracking
            st.session_state.progress_logs[msg_index] = []

            # Create async task with progress updates
            async def run_chat_with_updates():
                def send_progress(progress_msg: str):
                    st.session_state.progress_logs[msg_index].append({
                        "timestamp": datetime.now().strftime("%H:%M:%S"),
                        "message": progress_msg
                    })
                    # Update the UI in real-time
                    progress_placeholder.info(f"‚è≥ {progress_msg}")

                response = await chat(
                    st.session_state.session_id,
                    st.session_state.user_id,
                    prompt,
                    logger,
                    send_progress
                )
                return response

            # Run the async function
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            try:
                response = loop.run_until_complete(run_chat_with_updates())
            finally:
                loop.close()

            # Clear progress and show response
            progress_placeholder.empty()
            response_placeholder.write(response)

            # Show progress logs in expander
            if msg_index in st.session_state.progress_logs:
                with st.expander("üìä View Progress Logs"):
                    for log in st.session_state.progress_logs[msg_index]:
                        st.text(f"[{log['timestamp']}] {log['message']}")

    # Add assistant response to history
    st.session_state.messages.append({"role": "assistant", "content": response})

    st.rerun()
